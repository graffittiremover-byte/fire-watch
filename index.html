<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fire Watch</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#1f2937;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --ink:#e5e7eb; --ink2:#94a3b8; --pill:#0b1224; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,#0b1020,#0f172a 45%,#0b1020);
      color:var(--ink); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .app{width:100%; max-width:980px; display:grid; gap:16px}
    .row{display:grid; gap:16px}
    @media (min-width:900px){ .row{grid-template-columns:1.2fr .8fr} }
    .card{ background:linear-gradient(180deg,#12192f,#0f152a);
      border:1px solid rgba(148,163,184,.15); border-radius:18px; padding:20px; box-shadow:0 10px 35px rgba(0,0,0,.35) }
    .h{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .title{font-size:18px; font-weight:700; letter-spacing:.2px}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,.2); background:var(--pill); color:var(--ink2)}
    .status{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.2)}
    .dot{width:10px; height:10px; border-radius:50%}
    .s-idle{background:var(--muted)} .s-pending{background:var(--warn)} .s-active{background:var(--ok)} .s-bad{background:var(--bad)}
    .stack{display:grid; gap:12px}
    label{font-size:12px; color:var(--ink2)}
    input[type="text"], input[type="password"], select, textarea{
      width:100%; background:#0b1020; color:var(--ink);
      border:1px solid rgba(148,163,184,.2); border-radius:12px; padding:10px 12px; outline:none;
    }
    textarea{min-height:72px; resize:vertical}
    .btn{ appearance:none; border:none; border-radius:14px; padding:12px 16px; font-weight:700; cursor:pointer;
      background:linear-gradient(180deg,#1f2937,#111827); color:var(--ink); border:1px solid rgba(148,163,184,.2); }
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7); border-color:#0284c7; color:white}
    .btn.ok{background:linear-gradient(180deg,#16a34a,#15803d); border-color:#15803d; color:white}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706); border-color:#d97706; color:black}
    .btn.bad{background:linear-gradient(180deg,#dc2626,#b91c1c); border-color:#b91c1c; color:white}
    .btn.ghost{background:transparent}
    .rowgrid{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    .muted{color:var(--ink2); font-size:13px}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{padding:10px; border-bottom:1px solid rgba(148,163,184,.12); text-align:left}
    th{color:#a8b3cf; font-weight:600}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    dialog{ border:none; border-radius:16px; padding:0; background:transparent; max-width:520px; width:calc(100% - 32px) }
    .modal{background:linear-gradient(180deg,#12192f,#0f152a); border:1px solid rgba(148,163,184,.15); border-radius:16px; padding:18px}
    .modal .head{font-weight:800; margin-bottom:6px}
    .modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  </style>
</head>
<body>
  <main class="app">
    <section class="card">
      <div class="h">
        <div class="title">Fire Watch Console</div>
        <div id="statusPill" class="status">
          <div id="statusDot" class="dot s-idle"></div>
          <div id="statusText">Idle</div>
        </div>
      </div>
      <div class="flex" style="margin-top:10px;">
        <div class="pill">Timezone: America/Toronto</div>
        <div id="userPill" class="pill">Not signed in</div>
        <div id="backendPill" class="pill">Backend: connecting…</div>
      </div>
    </section>

    <div class="row">
      <section class="card stack">
        <div class="h">
          <div class="title">Control Panel</div>
          <div class="toolbar">
            <button id="btnLogin" class="btn">Sign in</button>
            <button id="btnLogout" class="btn ghost" style="display:none">Sign out</button>
          </div>
        </div>

        <div id="panelIdle" class="stack">
          <div class="muted">Current state: <b>Idle</b>. Start a Fire Watch.</div>
          <button id="btnStart" class="btn primary">Start Fire Watch</button>
        </div>

        <div id="panelPending" class="stack" style="display:none">
          <div class="muted">Status: <b>Waiting on Front Desk to confirm</b>.</div>
          <div class="rowgrid">
            <div><b>Requested by:</b> <span id="pendingBy"></span></div>
            <div><b>At:</b> <span id="pendingAt"></span></div>
          </div>
          <div class="toolbar">
            <button id="btnAcknowledge" class="btn ok" style="display:none">Acknowledge (Front Desk)</button>
            <button id="btnCancel" class="btn bad">Cancel Request</button>
          </div>
        </div>

        <div id="panelActive" class="stack" style="display:none">
          <div class="muted">Status: <b>On Fire Watch</b>. Started <span id="activeSince"></span>.</div>
          <div class="rowgrid">
            <div><b>Started by:</b> <span id="activeBy"></span></div>
            <div><b>Acknowledged by:</b> <span id="activeAck"></span></div>
          </div>
          <button id="btnEnd" class="btn warn">End Fire Watch</button>
        </div>
      </section>

      <section class="card stack">
        <div class="h">
          <div class="title">Event Log</div>
          <div class="toolbar">
            <button id="btnExport" class="btn ghost">Export CSV</button>
            <span class="muted">Realtime + DB</span>
          </div>
        </div>
        <div style="overflow:auto; max-height:380px; border:1px solid rgba(148,163,184,.12); border-radius:12px;">
          <table id="logTable">
            <thead><tr>
              <th>Time</th><th>Action</th><th>Role</th><th>Name</th><th>Details</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted">PINs: <small>Engineering 4156</small> · <small>Front Desk 6666</small></div>
      </section>
    </div>
  </main>

  <!-- Supabase FIRST (CDN + client + ping) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://uuoyhuxaklbyvfayilcy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1b3lodXhha2xieXZmYXlpbGN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzA0NzEsImV4cCI6MjA3Njk0NjQ3MX0.Ahdw5G3woFlLjMjTWuS8uqdQYcB7KnDL_MCaFYKkMIs";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    (async () => {
      const { error } = await sb.from('fire_watches').select('id',{ head:true, count:'exact' });
      document.getElementById('backendPill').textContent = error ? 'Backend: connection error' : 'Backend: connected';
      if (error) console.error(error);
    })();
  </script>

  <!-- App logic -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ========= CONSTANTS / STATE =========
    const S = { IDLE:'IDLE', PENDING:'PENDING_ACK', ACTIVE:'ACTIVE' };
    const state = { status:S.IDLE, current:null, user:null, logs:[] };

    // ========= DOM LOOKUP =========
    const ids = [
      'statusDot','statusText','userPill','panelIdle','panelPending','panelActive',
      'btnLogin','btnLogout','btnStart','btnAcknowledge','btnCancel','btnEnd','btnExport',
      'pendingBy','pendingAt','activeSince','activeBy','activeAck',
      'dlgLogin','loginRole','loginPin','loginName','btnDoLogin',
      'dlgStartEng','engReason','btnDoStartEng',
      'dlgStartFD','fdStartType','fdBypassWrap','fdPanelBy','fdReason','btnDoStartFD',
      'dlgAck','ackName','btnDoAck',
      'dlgEnd','endName','endNotes','btnDoEnd'
    ];
    const el = Object.fromEntries(ids.map(id => [id, document.getElementById(id)]));
    // Sanity check: log missing IDs to help debug
    const missing = ids.filter(id => !el[id]);
    if (missing.length) {
      console.error('Missing elements with these IDs:', missing);
      // Hard stop so we don’t attach handlers to null
      return;
    }

    const fmt = ts => new Date(ts).toLocaleString('en-CA',{timeZone:'America/Toronto'});
    const setStatus = s => {
      el.statusDot.className = 'dot ' + (s===S.IDLE?'s-idle':s===S.PENDING?'s-pending':'s-active');
      el.statusText.textContent = s===S.IDLE?'Idle':s===S.PENDING?'Pending Acknowledgement':'Active';
    };
    const requireName = v => v && v.trim().length>=2;
    const log = (action,details='')=>{
      state.logs.unshift({ts:Date.now(),action,role:state.user?.role||'-',name:state.user?.name||'-',details});
      document.querySelector('#logTable tbody').innerHTML = state.logs.map(l=>`
        <tr><td>${fmt(l.ts)}</td><td>${l.action}</td><td>${l.role}</td><td>${l.name}</td><td>${l.details||''}</td></tr>
      `).join('');
    };
    const setUser = u => {
      state.user=u;
      el.userPill.textContent = u?`${u.role==='ENG'?'Engineering':'Front Desk'} — ${u.name}`:'Not signed in';
      el.btnLogin.style.display = u?'none':'inline-block';
      el.btnLogout.style.display = u?'inline-block':'none';
      render();
    };

    function render(){
      setStatus(state.status);
      el.panelIdle.style.display = state.status===S.IDLE?'grid':'none';
      el.panelPending.style.display = state.status===S.PENDING?'grid':'none';
      el.panelActive.style.display = state.status===S.ACTIVE?'grid':'none';

      if(state.current){
        if(state.status===S.PENDING){
          el.pendingBy.textContent = `${state.current.started_by_role==='ENG'?'Engineering':'Front Desk'} — ${state.current.started_by_name}`;
          el.pendingAt.textContent = fmt(state.current.started_at || Date.now());
          const waitingForFD = state.current.started_by_role==='ENG';
          el.btnAcknowledge.style.display =
            (waitingForFD && state.user?.role==='FD') ||
            (!waitingForFD && state.user?.role==='ENG') ? 'inline-block':'none';
        }
        if(state.status===S.ACTIVE){
          el.activeSince.textContent = fmt(state.current.started_at || Date.now());
          el.activeBy.textContent = `${state.current.started_by_role==='ENG'?'Engineering':'Front Desk'} — ${state.current.started_by_name}`;
          el.activeAck.textContent = state.current.bypass_used
            ? `Bypass used (Panel by: ${state.current.panel_by_name || '—'})`
            : (state.current.fd_ack_by_name ? `Front Desk — ${state.current.fd_ack_by_name}` : '—');
        }
      }
    }

    // ========= DB HELPERS =========
    async function fetchCurrent(){
      const { data, error } = await sb.from('fire_watches')
        .select('*')
        .in('status',['PENDING_ACK','ACTIVE'])
        .order('started_at',{ascending:false})
        .limit(1);
      if(error){ console.error('fetchCurrent', error); return null; }
      return (data && data[0]) || null;
    }
    function applyRow(row){
      if(!row){ state.status=S.IDLE; state.current=null; render(); return; }
      state.current=row; state.status=row.status; render();
    }
    function subscribeRealtime(){
      sb.channel('rw_fire_watches')
        .on('postgres_changes',{event:'*',schema:'public',table:'fire_watches'}, async ()=>{
          const row = await fetchCurrent(); applyRow(row); log('sync','change');
        }).subscribe();
    }

    // ========= EVENTS =========
    el.btnLogin.onclick = ()=> el.dlgLogin.showModal();
    el.btnLogout.onclick = ()=>{ setUser(null); log('sign_out'); };

    el.btnDoLogin.onclick = ()=>{
      const role=el.loginRole.value, pin=el.loginPin.value.trim(), name=el.loginName.value.trim();
      if(!requireName(name)) return alert('Please enter your name.');
      if((role==='ENG' && pin!=='4156')||(role==='FD' && pin!=='6666')) return alert('Wrong PIN for role.');
      setUser({role,name}); log('sign_in'); el.dlgLogin.close(); el.loginPin.value='';
    };

    el.btnStart.onclick = ()=>{
      if(!state.user) return alert('Sign in first.');
      if(state.status !== S.IDLE) return alert('A session exists. End or cancel it first.');
      if(state.user.role==='ENG') el.dlgStartEng.showModal(); else el.dlgStartFD.showModal();
    };

    el.fdStartType.onchange = ()=>{ el.fdBypassWrap.style.display = el.fdStartType.value==='bypass'?'grid':'none'; };

    // ENG -> Start
    el.btnDoStartEng.onclick = async ()=>{
      const reason = el.engReason.value.trim()||null; el.engReason.value=''; el.dlgStartEng.close();
      const { data, error } = await sb.from('fire_watches').insert({
        status:'PENDING_ACK', started_by_role:'ENG', started_by_name:state.user.name, reason
      }).select('*').single();
      if(error){ console.error(error); log('db_error', error.message||'insert failed'); alert('Insert failed'); return; }
      log('start_request_eng', reason?`Reason: ${reason}`:''); applyRow(data);
    };

    // FD -> Start
    el.btnDoStartFD.onclick = async ()=>{
      const type=el.fdStartType.value, reason=el.fdReason.value.trim()||null; el.fdReason.value=''; el.dlgStartFD.close();
      if(type==='bypass'){
        const panelBy = el.fdPanelBy.value.trim(); if(!requireName(panelBy)) return alert('Enter who put the panel on fire watch.');
        el.fdPanelBy.value='';
        const { data, error } = await sb.from('fire_watches').insert({
          status:'ACTIVE', started_by_role:'FD', started_by_name:state.user.name, reason,
          bypass_used:true, panel_by_name:panelBy, fd_ack:true, fd_ack_by_name:state.user.name, fd_ack_at:new Date().toISOString()
        }).select('*').single();
        if(error){ console.error(error); log('db_error', error.message||'insert failed'); alert('Insert failed'); return; }
        log('start_fd_bypass',`Panel by: ${panelBy}`+(reason?` — Reason: ${reason}`:'')); applyRow(data);
      }else{
        const { data, error } = await sb.from('fire_watches').insert({
          status:'PENDING_ACK', started_by_role:'FD', started_by_name:state.user.name, reason
        }).select('*').single();
        if(error){ console.error(error); log('db_error', error.message||'insert failed'); alert('Insert failed'); return; }
        log('start_request_fd', reason?`Reason: ${reason}`:''); applyRow(data);
      }
    };

    el.btnCancel.onclick = async ()=>{
      if(!state.current || state.status!==S.PENDING) return;
      const { error } = await sb.from('fire_watches').update({
        status:'ENDED', ended_at:new Date().toISOString(),
        ended_by_role:state.user?.role||null, ended_by_name:state.user?.name||null, notes:'cancelled while pending'
      }).eq('id', state.current.id);
      if(error){ console.error(error); alert('Cancel failed'); return; }
      log('cancel_request',`Cancelled by ${state.user?.role||'-'}`);
    };

    el.btnAcknowledge.onclick = ()=>{ if(!state.user) return alert('Sign in first.'); el.dlgAck.showModal(); };
    el.btnDoAck.onclick = async ()=>{
      const n=el.ackName.value.trim(); if(!requireName(n)) return alert('Enter your name.');
      el.ackName.value=''; el.dlgAck.close(); if(!state.current) return;
      const { error } = await sb.from('fire_watches').update({
        status:'ACTIVE', fd_ack:true, fd_ack_by_name:n, fd_ack_at:new Date().toISOString()
      }).eq('id', state.current.id);
      if(error){ console.error(error); alert('Acknowledge failed'); return; }
      log('acknowledge',`by ${n}`);
    };

    el.btnEnd.onclick = ()=>{ if(!state.user) return alert('Sign in first.'); el.dlgEnd.showModal(); };
    el.btnDoEnd.onclick = async ()=>{
      const n=el.endName.value.trim(); if(!requireName(n)) return alert('Enter your name.');
      const notes=el.endNotes.value.trim(); el.endName.value=''; el.endNotes.value=''; el.dlgEnd.close(); if(!state.current) return;
      const { error } = await sb.from('fire_watches').update({
        status:'ENDED', ended_at:new Date().toISOString(), ended_by_role:state.user.role, ended_by_name:n, notes:notes||null
      }).eq('id', state.current.id);
      if(error){ console.error(error); alert('End failed'); return; }
      log('end_fire_watch', notes?`Notes: ${notes}`:'');
    };

    // Initial sync + realtime
    (async () => {
      const row = await fetchCurrent(); applyRow(row);
      // Toggle table Realtime ON in Supabase UI if you want live multi-user sync
      sb.channel('rw_fire_watches')
        .on('postgres_changes',{event:'*',schema:'public',table:'fire_watches'}, async ()=>{
          const r = await fetchCurrent(); applyRow(r); log('sync','change'); })
        .subscribe();
    })();
  });
  </script>
</body>
</html>
