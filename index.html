<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fire Watch</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Force newest build on every deploy -->
  <script>
  (function () {
    const APP_VERSION = "2025-10-25-11";  /* bump on each commit */
    const u = new URL(location.href);
    if (u.searchParams.get("v") !== APP_VERSION) {
      u.searchParams.set("v", APP_VERSION);
      location.replace(u.toString());
    }
  })();
  </script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <!-- tiny inline favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='50%25' x='50%25' dy='.35em' text-anchor='middle'%3EðŸ”¥%3C/text%3E%3C/svg%3E">

  <style>
    :root{
      --bg1:#0b1020; --bg2:#0f172a;            /* Idle theme */
      --card:#111827; --muted:#1f2937;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --ink:#e5e7eb; --ink2:#94a3b8; --pill:#0b1224;
      --table-line: rgba(148,163,184,.12);
    }

    /* Theme backgrounds by status */
    body.theme-idle{ background:linear-gradient(180deg,#0b1020,#0f172a 45%,#0b1020); }
    body.theme-pending{ background:linear-gradient(180deg,#221705,#3b2306 45%,#221705); }
    body.theme-active{ background:linear-gradient(180deg,#06210e,#0c3b1a 45%,#06210e); }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--ink); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
      transition: background 300ms ease;
    }
    .app{width:100%; max-width:1100px; display:grid; gap:16px}
    .row{display:grid; gap:16px}
    @media (min-width:980px){ .row{grid-template-columns:1.2fr .8fr} }
    .card{ background:linear-gradient(180deg,#12192f,#0f152a);
      border:1px solid rgba(148,163,184,.15); border-radius:18px; padding:20px; box-shadow:0 10px 35px rgba(0,0,0,.35) }
    .h{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .title{font-size:18px; font-weight:700; letter-spacing:.2px}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,.2); background:var(--pill); color:var(--ink2)}
    .pill.bad{background:#2a0f12; border-color:#7f1d1d; color:#fecaca}
    .status{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.2)}
    .dot{width:10px; height:10px; border-radius:50%}
    .s-idle{background:var(--muted)} .s-pending{background:var(--warn)} .s-active{background:var(--ok)}
    .stack{display:grid; gap:12px}
    label{font-size:12px; color:var(--ink2)}
    input[type="text"], input[type="password"], select, textarea{
      width:100%; background:#0b1020; color:var(--ink);
      border:1px solid rgba(148,163,184,.2); border-radius:12px; padding:10px 12px; outline:none;
    }
    textarea{min-height:72px; resize:vertical}
    .btn{ appearance:none; border:none; border-radius:14px; padding:12px 16px; font-weight:700; cursor:pointer;
      background:linear-gradient(180deg,#1f2937,#111827); color:var(--ink); border:1px solid rgba(148,163,184,.2); }
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7); border-color:#0284c7; color:white}
    .btn.ok{background:linear-gradient(180deg,#16a34a,#15803d); border-color:#15803d; color:white}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706); border-color:#d97706; color:black}
    .btn.bad{background:linear-gradient(180deg,#dc2626,#b91c1c); border-color:#b91c1c; color:white}
    .btn.ghost{background:transparent}
    .rowgrid{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    .muted{color:var(--ink2); font-size:13px}

    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{padding:10px; border-bottom:1px solid var(--table-line); text-align:left; vertical-align:top}
    th{color:#c9d2ea; font-weight:600}

    /* âœ¨ History table text lighter for readability */
    #histTable td{ color:#e5e7eb; }       /* light grey */
    #histTable tbody tr:hover{ background:rgba(148,163,184,.08); }

    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    dialog{ border:none; border-radius:16px; padding:0; background:transparent; max-width:980px; width:calc(100% - 32px) }
    .modal{background:linear-gradient(180deg,#12192f,#0f152a); border:1px solid rgba(148,163,184,.15); border-radius:16px; padding:18px}
    .modal .head{font-weight:800; margin-bottom:10px}
    .modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grid3{display:grid; gap:8px; grid-template-columns:1fr 1fr 1fr}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body class="theme-idle">
  <main class="app">
    <section class="card">
      <div class="h">
        <div class="title">Fire Watch Console</div>
        <div id="statusPill" class="status">
          <div id="statusDot" class="dot s-idle"></div>
          <div id="statusText">Idle</div>
        </div>
      </div>
      <div class="flex" style="margin-top:10px;">
        <div class="pill">Timezone: America/Toronto</div>
        <div id="userPill" class="pill">Not signed in</div>
        <div id="backendPill" class="pill">Backend: connectingâ€¦</div>
        <div id="eventsError" class="pill bad" style="display:none">Events insert blocked</div>
        <button id="btnOpenHistory" class="btn ghost">History</button>
      </div>
    </section>

    <div class="row">
      <!-- Left: Main Panel -->
      <section class="card stack">
        <div class="h">
          <div class="title">Control Panel</div>
          <div class="toolbar">
            <button id="btnLogin" class="btn">Sign in</button>
            <button id="btnLogout" class="btn ghost" style="display:none">Sign out</button>
          </div>
        </div>

        <div id="panelIdle" class="stack">
          <div class="muted">Current state: <b>Idle</b>. Start a Fire Watch.</div>
          <button id="btnStart" class="btn primary">Start Fire Watch</button>
        </div>

        <div id="panelPending" class="stack" style="display:none">
          <div class="muted">Status: <b>Waiting on Front Desk to confirm</b>.</div>
          <div class="rowgrid">
            <div><b>Requested by:</b> <span id="pendingBy"></span></div>
            <div><b>At:</b> <span id="pendingAt"></span></div>
          </div>
          <div class="toolbar">
            <button id="btnAcknowledge" class="btn ok" style="display:none">Acknowledge (Front Desk)</button>
            <button id="btnCancel" class="btn bad" style="display:none">Cancel Request</button>
          </div>
        </div>

        <div id="panelActive" class="stack" style="display:none">
          <div class="muted">Status: <b>On Fire Watch</b>. Started <span id="activeSince"></span>.</div>
          <div class="rowgrid">
            <div><b>Started by:</b> <span id="activeBy"></span></div>
            <div><b>Acknowledged by:</b> <span id="activeAck"></span></div>
          </div>
          <button id="btnEnd" class="btn warn">End Fire Watch</button>
        </div>
      </section>

      <!-- Right: Event Log (ALL activity from DB) -->
      <section class="card stack">
        <div class="h">
          <div class="title">Event Log (All activity)</div>
          <div class="toolbar">
            <button id="btnExport" class="btn ghost">Export CSV</button>
            <span class="muted">Realtime + DB</span>
          </div>
        </div>
        <div style="overflow:auto; max-height:380px; border:1px solid rgba(148,163,184,.12); border-radius:12px;">
          <table id="logTable">
            <thead><tr>
              <th>Time</th><th>Action</th><th>Role</th><th>Name</th><th>Details</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <!-- Login Modal -->
  <dialog id="dlgLogin">
    <div class="modal">
      <div class="head">Sign in</div>
      <div class="stack">
        <label>Role</label>
        <select id="loginRole">
          <option value="ENG">Engineering</option>
          <option value="FD">Front Desk</option>
        </select>
        <label>PIN</label>
        <input id="loginPin" type="password" placeholder="Enter PIN"/>
        <label>Your Name</label>
        <input id="loginName" type="text" placeholder="First & last name"/>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnCancelLogin">Cancel</button>
        <button id="btnDoLogin" class="btn primary">Sign in</button>
      </div>
    </div>
  </dialog>

  <!-- Start (Engineering) -->
  <dialog id="dlgStartEng">
    <div class="modal">
      <div class="head">Start Fire Watch (Engineering)</div>
      <div class="stack">
        <label>Reason (optional)</label>
        <textarea id="engReason" placeholder="e.g., Sprinkler impairment, system testing"></textarea>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnCancelStartEng">Cancel</button>
        <button id="btnDoStartEng" class="btn ok">Start â†’ Wait for Front Desk</button>
      </div>
    </div>
  </dialog>

  <!-- Start (Front Desk) -->
  <dialog id="dlgStartFD">
    <div class="modal">
      <div class="head">Start Fire Watch (Front Desk)</div>
      <div class="stack">
        <label>Start Type</label>
        <select id="fdStartType">
          <option value="normal">Normal (needs Engineering ack)</option>
          <option value="bypass">Bypass (Engineering not on site)</option>
        </select>
        <div id="fdBypassWrap" class="stack" style="display:none">
          <label>Who put the panel on fire watch? <span class="muted">(required)</span></label>
          <input id="fdPanelBy" type="text" placeholder="Name responsible for panel"/>
        </div>
        <label>Reason (optional)</label>
        <textarea id="fdReason" placeholder="e.g., Alarm vendor onsite, device isolation"></textarea>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnCancelStartFD">Cancel</button>
        <button id="btnDoStartFD" class="btn ok">Start</button>
      </div>
    </div>
  </dialog>

  <!-- Acknowledge (Front Desk) -->
  <dialog id="dlgAck">
    <div class="modal">
      <div class="head">Acknowledge Fire Watch (Front Desk)</div>
      <div class="stack">
        <label>Front Desk Name</label>
        <input id="ackName" type="text" placeholder="Your name"/>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnCancelAck">Cancel</button>
        <button id="btnDoAck" class="btn ok">Acknowledge</button>
      </div>
    </div>
  </dialog>

  <!-- End -->
  <dialog id="dlgEnd">
    <div class="modal">
      <div class="head">End Fire Watch</div>
      <div class="stack">
        <label>Your Name</label>
        <input id="endName" type="text" placeholder="Your name"/>
        <label>Notes (optional)</label>
        <textarea id="endNotes" placeholder="Anything to add"></textarea>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnCancelEnd">Cancel</button>
        <button id="btnDoEnd" class="btn bad">End Fire Watch</button>
      </div>
    </div>
  </dialog>

  <!-- History -->
  <dialog id="dlgHistory">
    <div class="modal">
      <div class="head">Fire Watch History</div>
      <div class="grid3">
        <input id="histSearch" type="text" placeholder="Search name / reason / notes" />
        <select id="histStatus">
          <option value="">All statuses</option>
          <option value="ACTIVE">ACTIVE</option>
          <option value="PENDING_ACK">PENDING_ACK</option>
          <option value="ENDED">ENDED</option>
        </select>
        <div class="toolbar">
          <button class="btn" id="btnHistRefresh">Refresh</button>
          <button class="btn ghost" id="btnHistExport">Export CSV</button>
        </div>
      </div>
      <div style="overflow:auto; max-height:60vh; margin-top:10px; border:1px solid rgba(148,163,184,.12); border-radius:12px;">
        <table id="histTable">
          <thead>
            <tr>
              <th class="nowrap">Started</th>
              <th>Status</th>
              <th>Started by</th>
              <th>Acknowledged</th>
              <th>Ended</th>
              <th>Reason / Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnCloseHistory">Close</button>
      </div>
    </div>
  </dialog>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://uuoyhuxaklbyvfayilcy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1b3lodXhha2xieXZmYXlpbGN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzA0NzEsImV4cCI6MjA3Njk0NjQ3MX0.Ahdw5G3woFlLjMjTWuS8uqdQYcB7KnDL_MCaFYKkMIs";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- App logic -->
  <script>
    const S = { IDLE:'IDLE', PENDING:'PENDING_ACK', ACTIVE:'ACTIVE' };
    const state = { status:S.IDLE, current:null, user:null, history:[], events:[] };
    const tz = 'America/Toronto';
    const fmt = ts => ts ? new Date(ts).toLocaleString('en-CA',{timeZone:tz}) : 'â€”';
    const requireName = v => v && v.trim().length>=2;

    function $(id){ return document.getElementById(id); }

    function setThemeForStatus(s){
      document.body.classList.remove('theme-idle','theme-pending','theme-active');
      if(s===S.ACTIVE) document.body.classList.add('theme-active');
      else if(s===S.PENDING) document.body.classList.add('theme-pending');
      else document.body.classList.add('theme-idle');
    }

    function setStatus(s){
      setThemeForStatus(s);
      $('statusDot').className = 'dot ' + (s===S.IDLE?'s-idle':s===S.PENDING?'s-pending':'s-active');
      $('statusText').textContent = s===S.IDLE?'Idle':s===S.PENDING?'Pending Acknowledgement':'Active';
    }

    function render(){
      setStatus(state.status);
      $('panelIdle').style.display    = state.status===S.IDLE?'grid':'none';
      $('panelPending').style.display = state.status===S.PENDING?'grid':'none';
      $('panelActive').style.display  = state.status===S.ACTIVE?'grid':'none';
      $('btnCancel').style.display = (state.status===S.PENDING && state.user) ? 'inline-block' : 'none';

      if(state.current){
        if(state.status===S.PENDING){
          $('pendingBy').textContent = `${state.current.started_by_role==='ENG'?'Engineering':'Front Desk'} â€” ${state.current.started_by_name}`;
          $('pendingAt').textContent = fmt(state.current.started_at || Date.now());
          const waitingForFD = state.current.started_by_role==='ENG';
          const showAck = (waitingForFD && state.user?.role==='FD') || (!waitingForFD && state.user?.role==='ENG');
          $('btnAcknowledge').style.display = showAck ? 'inline-block':'none';
        }
        if(state.status===S.ACTIVE){
          $('activeSince').textContent = fmt(state.current.started_at || Date.now());
          $('activeBy').textContent = `${state.current.started_by_role==='ENG'?'Engineering':'Front Desk'} â€” ${state.current.started_by_name}`;
          $('activeAck').textContent = state.current.bypass_used
            ? `Bypass used (Panel by: ${state.current.panel_by_name || 'â€”'})`
            : (state.current.fd_ack_by_name ? `Front Desk â€” ${state.current.fd_ack_by_name}` : 'â€”');
        }
      }
    }

    function setUser(u){
      state.user = u;
      $('userPill').textContent = u?`${u.role==='ENG'?'Engineering':'Front Desk'} â€” ${u.name}`:'Not signed in';
      $('btnLogin').style.display = u?'none':'inline-block';
      $('btnLogout').style.display = u?'inline-block':'none';
      render();
    }

    /* ------------ GLOBAL EVENTS (DB) --------------- */
    async function fetchEvents(){
      const { data, error } = await sb.from('events').select('*').order('id',{ascending:false}).limit(200);
      if(error){ console.error('fetchEvents', error); return; }
      state.events = data || [];
      renderEvents();
    }
    function renderEvents(){
      const tbody = document.querySelector('#logTable tbody');
      tbody.innerHTML = (state.events||[]).map(e => `
        <tr>
          <td>${fmt(e.created_at)}</td>
          <td>${e.action||''}</td>
          <td>${e.role||''}</td>
          <td>${e.name||''}</td>
          <td>${(e.details||'').replace(/\n/g,'<br>')}</td>
        </tr>
      `).join('') || `<tr><td colspan="5" class="muted">No events yet.</td></tr>`;
    }
    function exportEvents(){
      const rows=[['Time','Action','Role','Name','Details']];
      (state.events||[]).slice().reverse().forEach(e=>{
        rows.push([fmt(e.created_at), e.action||'', e.role||'', e.name||'', (e.details||'').replace(/\n/g,' ')]);
      });
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`firewatch_events_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
    }
    async function logEvent(action, details=''){
      const payload = { action, role: state.user?.role || null, name: state.user?.name || null, details: details || null };
      const { error } = await sb.from('events').insert(payload);
      if (error) {
        console.error('logEvent insert failed:', error);
        $('eventsError').style.display = 'inline-block';
      }
    }
    function subscribeEvents(){
      sb.channel('rw_events')
        .on('postgres_changes',{event:'*',schema:'public',table:'events'}, async ()=>{
          await fetchEvents();
        }).subscribe();
    }

    /* ----------- FIRE WATCH (CURRENT) ------------- */
    async function fetchCurrent(){
      const { data, error } = await sb.from('fire_watches')
        .select('*').in('status',['PENDING_ACK','ACTIVE'])
        .order('started_at',{ascending:false}).limit(1);
      if(error){ console.error('fetchCurrent', error); return null; }
      return (data && data[0]) || null;
    }
    function applyRow(row){
      if(!row){ state.status=S.IDLE; state.current=null; render(); return; }
      state.current=row; state.status=row.status; render();
    }
    function subscribeRealtime(){
      sb.channel('rw_fire_watches')
        .on('postgres_changes',{event:'*',schema:'public',table:'fire_watches'}, async ()=>{
          const row = await fetchCurrent(); applyRow(row);
        }).subscribe();
    }

    /* ---------------- HISTORY -------------------- */
    function openHistory(){ $('dlgHistory').showModal(); loadHistory(); }
    async function loadHistory(){
      const q = ($('histSearch').value||'').trim().toLowerCase();
      const statusFilter = $('histStatus').value;

      let query = sb.from('fire_watches').select('*').order('started_at', { ascending:false }).limit(200);
      if (statusFilter) query = query.eq('status', statusFilter);

      const { data, error } = await query;
      if (error){ console.error('history load', error); return; }

      const filtered = data.filter(r=>{
        if(!q) return true;
        const hay = [r.started_by_name, r.started_by_role, r.fd_ack_by_name, r.panel_by_name, r.ended_by_name, r.reason, r.notes]
          .filter(Boolean).join(' ').toLowerCase();
        return hay.includes(q);
      });

      state.history = filtered;
      renderHistory();
    }
    function renderHistory(){
      const tbody = document.querySelector('#histTable tbody');
      const rows = state.history.map(r=>{
        const started = fmt(r.started_at);
        const startedBy = `${r.started_by_role||'â€”'} â€” ${r.started_by_name||'â€”'}`;
        const ack = r.bypass_used ? `Bypass âœ“ (Panel by: ${r.panel_by_name||'â€”'})`
                                  : (r.fd_ack ? `FD: ${r.fd_ack_by_name||'â€”'} @ ${fmt(r.fd_ack_at)}` : 'â€”');
        const ended = r.status==='ENDED' ? `${fmt(r.ended_at)} Â· by ${r.ended_by_role||'â€”'} â€” ${r.ended_by_name||'â€”'}` : 'â€”';
        const rn = [r.reason, r.notes].filter(Boolean).join(' â€¢ ');
        return `<tr><td class="nowrap">${started}</td><td>${r.status}</td><td>${startedBy}</td><td>${ack}</td><td>${ended}</td><td>${rn||''}</td></tr>`;
      }).join('');
      tbody.innerHTML = rows || `<tr><td colspan="6" class="muted">No records found.</td></tr>`;
    }
    function exportHistory(){
      const rows=[['Started','Status','Started By','Acknowledged','Ended','Reason / Notes']];
      state.history.slice().forEach(r=>{
        const started = fmt(r.started_at);
        const startedBy = `${r.started_by_role||'â€”'} â€” ${r.started_by_name||'â€”'}`;
        const ack = r.bypass_used ? `Bypass (Panel by: ${r.panel_by_name||'â€”'})`
                                  : (r.fd_ack ? `FD: ${r.fd_ack_by_name||'â€”'} @ ${fmt(r.fd_ack_at)}` : 'â€”');
        const ended = r.status==='ENDED' ? `${fmt(r.ended_at)} Â· by ${r.ended_by_role||'â€”'} â€” ${r.ended_by_name||'â€”'}` : 'â€”';
        const rn = [r.reason, r.notes].filter(Boolean).join(' | ');
        rows.push([started, r.status, startedBy, ack, ended, rn]);
      });
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`firewatch_history_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
    }

    /* --------------- Handlers + wiring --------------- */
    function handleLoginOpen(){ $('dlgLogin').showModal(); }
    function handleLogout(){ logEvent('sign_out'); setUser(null); }
    function handleDoLogin(){
      const role=$('loginRole').value;
      const pin=$('loginPin').value.trim();
      const name=$('loginName').value.trim();
      if(!requireName(name)) return alert('Please enter your name.');
      if((role==='ENG' && pin!=='4156')||(role==='FD' && pin!=='6666')) return alert('Wrong PIN for role.');
      setUser({role,name}); $('dlgLogin').close(); $('loginPin').value='';
      logEvent('sign_in', `role=${role}`);
    }
    function handleStart(){
      if(!state.user) return alert('Sign in first.');
      if(state.status!==S.IDLE) return alert('A session exists. End or cancel it first.');
      if(state.user.role==='ENG') $('dlgStartEng').showModal(); else $('dlgStartFD').showModal();
    }
    function handleFDTypeChange(){
      const type=$('fdStartType').value;
      $('fdBypassWrap').style.display = type==='bypass'?'grid':'none';
    }
    async function handleDoStartEng(){
      const ta=$('engReason'); const reason = ta.value.trim()||null; ta.value='';
      $('dlgStartEng').close();
      const { data, error } = await sb.from('fire_watches').insert({
        status:'PENDING_ACK', started_by_role:'ENG', started_by_name:state.user.name, reason
      }).select('*').single();
      if(error){ console.error(error); alert('Insert failed'); return; }
      logEvent('start_request_eng', reason?`reason=${reason}`:'');
      applyRow(data);
    }
    async function handleDoStartFD(){
      const type=$('fdStartType').value;
      const reason=($('fdReason').value.trim()||null);
      $('fdReason').value=''; $('dlgStartFD').close();
      if(type==='bypass'){
        const panelBy = $('fdPanelBy').value.trim();
        if(!requireName(panelBy)) return alert('Enter who put the panel on fire watch.');
        $('fdPanelBy').value='';
        const { data, error } = await sb.from('fire_watches').insert({
          status:'ACTIVE', started_by_role:'FD', started_by_name:state.user.name, reason,
          bypass_used:true, panel_by_name:panelBy, fd_ack:true, fd_ack_by_name:state.user.name, fd_ack_at:new Date().toISOString()
        }).select('*').single();
        if(error){ console.error(error); alert('Insert failed'); return; }
        logEvent('start_fd_bypass', `panel_by=${panelBy}` + (reason?`; reason=${reason}`:''));
        applyRow(data);
      }else{
        const { data, error } = await sb.from('fire_watches').insert({
          status:'PENDING_ACK', started_by_role:'FD', started_by_name:state.user.name, reason
        }).select('*').single();
        if(error){ console.error(error); alert('Insert failed'); return; }
        logEvent('start_request_fd', reason?`reason=${reason}`:'');
        applyRow(data);
      }
    }
    function handleAckOpen(){ if(!state.user) return alert('Sign in first.'); $('dlgAck').showModal(); }
    async function handleDoAck(){
      const n=$('ackName').value.trim(); if(!requireName(n)) return alert('Enter your name.');
      $('ackName').value=''; $('dlgAck').close(); if(!state.current) return;
      const { error } = await sb.from('fire_watches').update({
        status:'ACTIVE', fd_ack:true, fd_ack_by_name:n, fd_ack_at:new Date().toISOString()
      }).eq('id', state.current.id);
      if(error){ console.error(error); alert('Acknowledge failed'); return; }
      logEvent('acknowledge', `by=${n}`);
    }
    async function handleCancel(){
      if(!state.user){ alert('Sign in first.'); return; }
      if(!state.current || state.status!==S.PENDING) return;
      const { error } = await sb.from('fire_watches').update({
        status:'ENDED', ended_at:new Date().toISOString(),
        ended_by_role:state.user?.role||null, ended_by_name:state.user?.name||null, notes:'cancelled while pending'
      }).eq('id', state.current.id);
      if(error){ console.error(error); alert('Cancel failed'); return; }
      logEvent('cancel_request', `by=${state.user?.role}/${state.user?.name}`);
    }
    function handleEndOpen(){ if(!state.user) return alert('Sign in first.'); $('dlgEnd').showModal(); }
    async function handleDoEnd(){
      const n=$('endName').value.trim(); if(!requireName(n)) return alert('Enter your name.');
      const notes=$('endNotes').value.trim();
      $('endName').value=''; $('endNotes').value=''; $('dlgEnd').close(); if(!state.current) return;
      const { error } = await sb.from('fire_watches').update({
        status:'ENDED', ended_at:new Date().toISOString(), ended_by_role:state.user.role, ended_by_name:n, notes:notes||null
      }).eq('id', state.current.id);
      if(error){ console.error(error); alert('End failed'); return; }
      logEvent('end_fire_watch', notes?`notes=${notes}`:'');
    }

    function sanityCheckIDs(){
      const ids = [
        'dlgLogin','dlgStartEng','dlgStartFD','dlgAck','dlgEnd','dlgHistory',
        'btnLogin','btnLogout','btnStart','btnAcknowledge','btnCancel','btnEnd',
        'btnOpenHistory',
        'btnDoLogin','btnDoStartEng','btnDoStartFD','btnDoAck','btnDoEnd',
        'btnCancelLogin','btnCancelStartEng','btnCancelStartFD','btnCancelAck','btnCancelEnd',
        'btnHistRefresh','btnHistExport','btnCloseHistory'
      ];
      const missing = ids.filter(id => !$(id));
      if (missing.length) console.warn('Missing elements with these IDs:', missing);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Wire buttons after DOM is ready
      $('btnLogin').onclick = handleLoginOpen;
      $('btnLogout').onclick = handleLogout;
      $('btnStart').onclick = handleStart;
      $('btnAcknowledge').onclick = handleAckOpen;
      $('btnCancel').onclick = handleCancel;
      $('btnEnd').onclick = handleEndOpen;
      $('btnOpenHistory').onclick = openHistory;

      $('btnDoLogin').onclick = handleDoLogin;
      $('btnCancelLogin').onclick = () => $('dlgLogin').close();

      $('btnDoStartEng').onclick = handleDoStartEng;
      $('btnCancelStartEng').onclick = () => $('dlgStartEng').close();

      $('fdStartType').onchange = handleFDTypeChange;
      $('btnDoStartFD').onclick = handleDoStartFD;
      $('btnCancelStartFD').onclick = () => $('dlgStartFD').close();

      $('btnDoAck').onclick = handleDoAck;
      $('btnCancelAck').onclick = () => $('dlgAck').close();

      $('btnDoEnd').onclick = handleDoEnd;
      $('btnCancelEnd').onclick = () => $('dlgEnd').close();

      $('btnHistRefresh').onclick = loadHistory;
      $('btnHistExport').onclick = exportHistory;
      $('btnCloseHistory').onclick = () => $('dlgHistory').close();

      sanityCheckIDs();

      // Backend connectivity pill
      (async () => {
        const { error } = await sb.from('fire_watches').select('id', { head:true, count:'exact' });
        $('backendPill').textContent = error ? 'Backend: connection error' : 'Backend: connected';
        if (error) console.error(error);
      })();

      // Initial data + realtime
      (async () => {
        const row = await fetchCurrent(); applyRow(row);
        await fetchEvents();
        subscribeRealtime();
        subscribeEvents();
        setInterval(fetchEvents, 5000);
      })();
    });
  </script>
</body>
</html>
